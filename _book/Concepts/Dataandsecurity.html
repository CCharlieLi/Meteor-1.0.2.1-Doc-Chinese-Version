<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>数据和安全 | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    <link rel="next" href="../Concepts/Reactivity.html" />
    
    
    <link rel="prev" href="../Concepts/Structuringyourapp.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="1.3" data-basepath=".." data-revision="1422254748753">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Meteor介绍
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.1" data-path="Quickstart.html">
            
                
                    <a href="../Quickstart.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.</b>
                        
                         快速开始
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.2" data-path="Principles.html">
            
                
                    <a href="../Principles.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.</b>
                        
                         Meteor设计原则
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.3" data-path="Resource.html">
            
                
                    <a href="../Resource.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.3.</b>
                        
                         开发者资源
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> 基本概念</span>
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="Concepts/WhatisMeteor.html">
            
                
                    <a href="../Concepts/WhatisMeteor.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         什么是Meteor？
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="Concepts/Structuringyourapp.html">
            
                
                    <a href="../Concepts/Structuringyourapp.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         结构化你的应用
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="1.3" data-path="Concepts/Dataandsecurity.html">
            
                
                    <a href="../Concepts/Dataandsecurity.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         数据和安全
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.4" data-path="Concepts/Reactivity.html">
            
                
                    <a href="../Concepts/Reactivity.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                         响应式
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="Concepts/Livehtmltemplates.html">
            
                
                    <a href="../Concepts/Livehtmltemplates.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         实时HTML模板
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_1">
                    
                        <h2 id="">数据和安全</h2>
<p>Meteor使得编写分布式客户端代码变得像访问本地数据库一样简单。简洁且安全，不用再部署单独的RPC（远程过程调用）终端，不用再手动配置客户端数据缓存来避免访问缓慢，不用再担心当数据发生改变时要小心地验证每个客户端的非法信息。</p>
<p>在Meteor中，客户端和服务器端共享同样的数据库API。同样的程序代码——如校验和计算部分——大多可以同时在客户端和服务器端运行。但是，运行在服务器端的代码可以直接访问数据库，运行在客户端的代码却不能。这里的差别是Meteor数据安全模型的基础。</p>
<blockquote>
<p>在默认情况下，一个新的Meteor应用包含了<code>autopublish</code>和<code>insecure</code>这两个包，都是用来模拟使用效果让每个客户端都拥有完全读/写数据库的权限。这两个包都是很有用的原型调试工具，但是并不适用于产品级的应用。当你准备发布产品级应用时，只需要<code>remove</code>掉这两个包就行了。</p>
</blockquote>
<p>每个Meteor客户端都包含一个内存中的数据库缓存。为了管理每个客户端的缓存，服务器端会发布包含JSON文件的数据集，客户端直接<code>subscribes</code>这些数据集。当数据集中的文件发生变化时，服务器端会向每个客户端发送更改数据库缓存信息。</p>
<p>大多数的Meteor应用都采用MongoDB作为数据库，因为目前MongoDB在Meteor中获得最好的支持，对于其他数据库的支持都会在将来陆续发布。<code>Mongo.Collection</code>用来声明并处理Mongo集合，通过Meteor的客户端Mongo模拟器——minimongo，我们可以同时在客户端和服务器端调用<code>Mongo.Collection</code>。</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// declare collections</span>
<span class="hljs-comment">// this code should be included in both the client and the server</span>
Rooms = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="hljs-string">"rooms"</span>);
Messages = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="hljs-string">"messages"</span>);
Parties = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="hljs-string">"parties"</span>);

<span class="hljs-comment">// server: populate collections with some initial documents</span>
Rooms.insert({name: <span class="hljs-string">"Conference Room A"</span>});
<span class="hljs-keyword">var</span> myRooms = Rooms.find({}).fetch();
Messages.insert({text: <span class="hljs-string">"Hello world"</span>, room: myRooms[<span class="hljs-number">0</span>]._id});
Parties.insert({name: <span class="hljs-string">"Super Bowl Party"</span>});
</code></pre>
<p><code>Publish</code>函数可以发布不同的数据集给每个客户端。在之前的实例中，一个已登陆的用户只能看到公共的，或者自己的，或者被邀请参与的<code>Party</code>文件。</p>
<p>一旦客户端获取到数据集，则将缓存作为本地数据库，极大地简化了客户端代码。任何读操作都不会消耗时间访问服务器，并且读取内容也限制在本地缓存的内容：在客户端对集合中的文件进行查询都只会返回服务器发布给该客户端的内容。</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// client: start a parties subscription</span>
Meteor.subscribe(<span class="hljs-string">"parties"</span>);

<span class="hljs-comment">// client: return array of Parties this client can read</span>
<span class="hljs-keyword">return</span> Parties.find().fetch(); <span class="hljs-comment">// synchronous!</span>
</code></pre>
<p>复杂的客户端程序可以开启或关闭获取数据集的功能，以控制本地缓存的数据量大小和网络流量。一旦关闭获取，所有与其相关的文件都会被从缓存中删除，只剩下其余开启获取的数据集的相关文件。</p>
<p>当客户端修改了本地缓存的一个或多个文件，会发送一条消息到服务器端请求同样的修改操作。服务器端根据一系列事先定义好的验证规则，对发起修改的请求进行检查。服务器只会执行验证通过的请求。</p>
<pre><code class="lang-javascipt">// server: dont allow client to insert a party
Parties.allow({
  insert: function (userId, party) {
    return false;
  }
});

// client: this will fail
var party = { ... };
Parties.insert(party);
</code></pre>
<p>当服务器端接受了修改操作，会对相应的数据库进行修改并自动地将修改操作传递到获取相应数据集的客户端。如果服务器没有接受修改请求，那么更新失败，服务器端数据库不会有任何修改，所有的客户端也不会有更新操作。</p>
<p>Meteor有一个很有意思的地方。当客户端发起一个写操作的请求到服务器端时，同时会立即修改本地的缓存数据，而不用耗费时间等待服务器响应，这就意味着界面会立即显示修改的数据。如果服务器接受了写操作的请求——一个行为正常的客户端发出的大部分请求都应该会被服务器所接受——那么客户端很快速地显示出修改后的界面，而不用等待一轮请求相应再来更新页面。如果服务器拒绝了写操作，Meteor会用服务器端的原始数据去修正之前被修改的客户端缓存数据。</p>
<p>把以上内容总结起来，这些技术就实现了延迟补偿。客户端拥有其所需数据的本地缓存，不用等待一次轮回从服务器获得数据。当客户端要修改数据时，这些修改操作不用等待服务器端的验证就能立即在本地执行，直到服务器端最终判断该操作是否被接受。</p>
<blockquote>
<p>当前版本的Meteor支持目前最流行的文件数据库MongoDB，当前部分的实例采用了<a href="http://docs.mongodb.org/manual/contents/" target="_blank">MongoDB API</a>。以后的版本中会支持更多的数据库。</p>
</blockquote>
<h3 id="">认证机制和账户</h3>
<p>Meteor包含一个功能全面的认证机制Meteor Account。它运用<a href="http://en.wikipedia.org/wiki/Bcrypt" target="_blank">bcrypt</a>算法来确保安全地密码登录，同时也集成了很多外部服务接口，包括Facebook，GitHub，Google，Meetup，Twitter和Weibo。Meteor Account定义了一个<code>Meteor.users</code>集合用来存放用户数据。</p>
<p>Meteor同时也包含一个预置的表单用来完成一些常见任务如登录，注册，修改密码和密码重置邮件功能。只需要用一行代码将Accounts UI包添加到你的应用中。<code>accounts-ui</code>包中甚至还包含了一个配置向导来一步步指引你在当前应用中创建外部登录服务。</p>
<h3 id="">输入验证</h3>
<p>Meteor允许你的方法和公共函数使用任何类型的JSON作为参数。（实际上，Meteor的有线协议支持EJSON格式，EJSON是一种扩展的JSON类型，可以支持一些常见类型如日期和二进制缓冲区。）Javascript动态类型意味着你不用为每个变量都事先声明类型，但是事先声明变量类型的好处在于，可以确保从客户端传到相应方法和公共函数的参数类型和预期的一致。</p>
<p>Meteor提供了一个轻量级的库用来检查参数或其他值的类型是否和预期的一致。只需要在函数开始处添加代码<code>check(username, String)</code>或者<code>check(office, {building: String, room: Number})</code>。如果参数类型和预期的不符，这里的<code>check</code>函数会抛出异常。</p>
<p>Meteor同时也提供了一个更加简单的方法让所有方法和公共函数验证它们的参数类型。只需要运行<code>meteor add audit-argument-checks</code>，这样凡是没有对参数类型进行验证的方法和公共函数都会抛出异常。</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../Concepts/Structuringyourapp.html" class="navigation navigation-prev " aria-label="Previous page: 结构化你的应用"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../Concepts/Reactivity.html" class="navigation navigation-next " aria-label="Next page: 响应式"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
